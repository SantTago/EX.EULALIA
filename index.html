<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Fisio Kids Pro - Dra. Eul√°lia Angelim</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Nunito', sans-serif; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .card-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02); }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; border-radius: 16px; font-weight: 800; }
        .btn-primary:hover { transform: scale(1.02); filter: brightness(1.1); }
        .tab-active { color: #6366f1 !important; border-bottom: 4px solid #6366f1; }
        .image-container { overflow: hidden; border-radius: 24px; position: relative; height: 180px; background: #f1f5f9; }
        .image-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body class="h-full bg-slate-50 text-slate-800">

<div id="app" class="h-full flex flex-col">
    <header class="gradient-bg text-white p-6 shadow-2xl z-30">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-white/20 backdrop-blur-xl rounded-2xl flex items-center justify-center text-4xl shadow-inner border border-white/30">üë∂</div>
                <div>
                    <h1 class="text-3xl font-black tracking-tighter">Fisio Kids <span class="font-thin opacity-80 text-2xl">PRO</span></h1>
                    <p class="text-[10px] font-bold uppercase tracking-[0.3em] opacity-90">Dra. Eul√°lia Angelim</p>
                </div>
            </div>
            <div class="flex bg-white/20 p-1 rounded-xl">
                <button onclick="setMode('pro')" id="btn-pro" class="px-4 py-1 rounded-lg text-[10px] font-black bg-white text-indigo-600">PROFISSIONAL</button>
                <button onclick="setMode('mae')" id="btn-mae" class="px-4 py-1 rounded-lg text-[10px] font-black">M√ÉE</button>
            </div>
        </div>
    </header>

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-20 overflow-x-auto">
        <div class="max-w-7xl mx-auto flex">
            <button onclick="switchTab('patients')" id="tab-patients" class="tab-active flex-1 min-w-[120px] py-5 text-sm font-black text-slate-400">üë∂ PACIENTES</button>
            <button onclick="switchTab('exercises')" id="tab-exercises" class="flex-1 min-w-[120px] py-5 text-sm font-black text-slate-400">üèãÔ∏è EXERC√çCIOS</button>
            <button onclick="switchTab('prescriptions')" id="tab-prescriptions" class="flex-1 min-w-[120px] py-5 text-sm font-black text-slate-400">üìã PRESCRI√á√ÉO/MAPA</button>
        </div>
    </nav>

    <main class="flex-1 overflow-auto p-4 md:p-10">
        <div class="max-w-7xl mx-auto">

            <section id="section-patients" class="animate-slide">
                <div class="flex flex-col md:flex-row gap-6 mb-10 items-end">
                    <div class="flex-1 w-full">
                        <input type="text" id="search-pat" onkeyup="renderPatients()" placeholder="Buscar pequeno(a)..." class="w-full h-16 bg-white rounded-2xl border-2 border-slate-100 px-6 shadow-sm text-lg font-bold">
                    </div>
                    <button onclick="toggleForm('patient-form-container')" id="btn-new-pat" class="h-16 px-8 btn-primary flex items-center gap-3">
                        <span>üë∂</span> NOVO PACIENTE
                    </button>
                </div>

                <div id="patient-form-container" class="hidden bg-white rounded-[32px] card-shadow p-8 mb-10 border-2 border-indigo-50">
                    <form id="patient-form" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <input type="hidden" id="pat-id">
                        <div class="md:col-span-2">
                            <input type="text" id="pat-name" required placeholder="Nome do Beb√™" class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold">
                        </div>
                        <div class="md:col-span-1">
                            <input type="date" id="pat-birth" required class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold">
                        </div>
                        <div class="md:col-span-1">
                            <select id="pat-gender" class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold">
                                <option value="Masculino">Menino üë¶</option>
                                <option value="Feminino">Menina üëß</option>
                            </select>
                        </div>
                        <div class="md:col-span-4">
                            <textarea id="pat-diag" placeholder="Observa√ß√µes Cl√≠nicas / Diagn√≥stico" class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold"></textarea>
                        </div>
                        <div class="md:col-span-4 flex justify-end gap-4">
                            <button type="submit" class="btn-primary px-12 py-4">CADASTRAR</button>
                        </div>
                    </form>
                </div>
                <div id="patients-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </section>

            <section id="section-exercises" class="hidden animate-slide">
                <div class="flex flex-col md:flex-row gap-6 mb-10 items-end">
                    <div class="flex-1 w-full">
                        <input type="text" id="search-ex" onkeyup="renderExercises()" placeholder="Pesquisar exerc√≠cio ou eixo..." class="w-full h-16 bg-white rounded-2xl border-2 border-slate-100 px-6 shadow-sm text-lg font-bold">
                    </div>
                    <button onclick="toggleForm('exercise-form-container')" id="btn-new-ex" class="h-16 px-8 btn-primary flex items-center gap-3">
                        <span>üèãÔ∏è</span> NOVO EXERC√çCIO
                    </button>
                </div>

                <div id="exercise-form-container" class="hidden bg-white rounded-[32px] card-shadow p-8 mb-10 border-2 border-purple-50">
                    <form id="exercise-form" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <input type="hidden" id="ex-id">
                        <div class="md:col-span-2">
                            <input type="text" id="ex-name" required placeholder="Nome do Exerc√≠cio" class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold">
                        </div>
                        <div class="md:col-span-2">
                            <select id="ex-collection" required class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold">
                                <option value="">Selecione o Eixo Neuromotor</option>
                                <option>Base Sensorial</option>
                                <option>Controle Cervical</option>
                                <option>Cintura Escapular</option>
                                <option>Organiza√ß√£o Lateral</option>
                                <option>Tronco / Core</option>
                                <option>Cintura P√©lvica</option>
                                <option>Progress√£o em Prona</option>
                                <option>Transi√ß√µes Posturais</option>
                                <option>Ortostatismo</option>
                                <option>Coordena√ß√£o Manual</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <select id="ex-age" required class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold">
                                <option value="0-2">0-2 meses</option>
                                <option value="3-4">3-4 meses</option>
                                <option value="5-6">5-6 meses</option>
                                <option value="7-8">7-8 meses</option>
                                <option value="9-10">9-10 meses</option>
                                <option value="11-12">11-12 meses</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <input type="url" id="ex-img" placeholder="Link da Imagem (URL)" class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold">
                        </div>
                        <div class="grid grid-cols-3 gap-2 md:col-span-2">
                            <input type="text" id="ex-time" placeholder="Tempo" class="p-4 bg-slate-50 rounded-xl border-none font-bold">
                            <input type="text" id="ex-reps" placeholder="Reps" class="p-4 bg-slate-50 rounded-xl border-none font-bold">
                            <input type="text" id="ex-series" placeholder="S√©ries" class="p-4 bg-slate-50 rounded-xl border-none font-bold">
                        </div>
                        <div class="md:col-span-4">
                            <textarea id="ex-desc" required placeholder="Instru√ß√µes e Objetivos..." class="w-full p-4 bg-slate-50 rounded-xl border-none font-bold"></textarea>
                        </div>
                        <div class="md:col-span-4 flex justify-end gap-4">
                            <button type="submit" class="btn-primary px-12 py-4">SALVAR AGORA</button>
                        </div>
                    </form>
                </div>
                <div id="exercises-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </section>

            <section id="section-prescriptions" class="hidden animate-slide">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white rounded-[32px] card-shadow p-8">
                            <h3 class="text-xs font-black text-slate-400 mb-4 uppercase">1. Selecionar Paciente</h3>
                            <div id="presc-patients-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>

                        <div id="map-container" class="bg-white rounded-[32px] card-shadow p-8 hidden">
                            <h3 class="text-xs font-black text-slate-400 mb-4 uppercase">2. Mapa de Evolu√ß√£o Corporal</h3>
                            <div id="body-map" class="space-y-3"></div>
                        </div>

                        <button onclick="generateSuperPDF()" class="w-full h-20 btn-primary rounded-[32px] text-lg shadow-xl flex items-center justify-center gap-4">
                            <span>üìÑ</span> GERAR PDF PREMIUM
                        </button>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="flex justify-between items-center mb-6">
                            <h3 id="presc-label" class="text-xs font-black text-slate-400 uppercase">3. Exerc√≠cios do Plano</h3>
                            <span id="presc-count" class="bg-indigo-600 text-white px-4 py-1 rounded-full text-[10px] font-black">0 SELECIONADOS</span>
                        </div>
                        <div id="presc-exercises-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<script>
    let appMode = 'pro';
    let exercises = JSON.parse(localStorage.getItem('fk_pro_ex_v9') || '[]');
    let patients = JSON.parse(localStorage.getItem('fk_pro_pat_v9') || '[]');
    let selectedExIds = new Set();
    let currentPatId = null;

    const axes = ["Base Sensorial", "Controle Cervical", "Cintura Escapular", "Organiza√ß√£o Lateral", "Tronco / Core", "Cintura P√©lvica", "Progress√£o em Prona", "Transi√ß√µes Posturais", "Ortostatismo", "Coordena√ß√£o Manual"];

    function setMode(mode) {
        appMode = mode;
        document.getElementById('btn-pro').className = mode === 'pro' ? 'px-4 py-1 rounded-lg text-[10px] font-black bg-white text-indigo-600' : 'px-4 py-1 rounded-lg text-[10px] font-black';
        document.getElementById('btn-mae').className = mode === 'mae' ? 'px-4 py-1 rounded-lg text-[10px] font-black bg-white text-indigo-600' : 'px-4 py-1 rounded-lg text-[10px] font-black';
        
        const proElements = ['btn-new-pat', 'btn-new-ex'];
        proElements.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = mode === 'pro' ? 'flex' : 'none';
        });
        
        renderExercises();
        renderPatients();
    }

    function switchTab(t) {
        ['patients', 'exercises', 'prescriptions'].forEach(s => {
            document.getElementById(`section-${s}`).classList.toggle('hidden', s !== t);
            document.getElementById(`tab-${s}`).classList.toggle('tab-active', s === t);
        });
        if(t === 'prescriptions') initPresc();
    }

    function toggleForm(id) { document.getElementById(id).classList.toggle('hidden'); }

    function calculateAge(date) {
        const birth = new Date(date);
        const now = new Date();
        let months = (now.getFullYear() - birth.getFullYear()) * 12 + (now.getMonth() - birth.getMonth());
        return Math.max(0, months);
    }

    function getRange(m) {
        if(m <= 2) return "0-2"; if(m <= 4) return "3-4"; if(m <= 6) return "5-6";
        if(m <= 8) return "7-8"; if(m <= 10) return "9-10"; return "11-12";
    }

    // --- PACIENTES ---
    document.getElementById('patient-form').onsubmit = (e) => {
        e.preventDefault();
        const p = {
            id: Date.now().toString(),
            name: document.getElementById('pat-name').value,
            birth: document.getElementById('pat-birth').value,
            gender: document.getElementById('pat-gender').value,
            diag: document.getElementById('pat-diag').value,
            progress: {}
        };
        patients.push(p);
        localStorage.setItem('fk_pro_pat_v9', JSON.stringify(patients));
        e.target.reset(); toggleForm('patient-form-container'); renderPatients();
    };

    function renderPatients() {
        const list = document.getElementById('patients-list');
        list.innerHTML = patients.map(p => `
            <div class="bg-white rounded-[32px] p-8 card-shadow border border-slate-50 flex flex-col items-center text-center">
                <div class="w-20 h-20 rounded-3xl ${p.gender==='Masculino'?'bg-blue-50 text-blue-500':'bg-pink-50 text-pink-500'} flex items-center justify-center text-3xl mb-4">
                    ${p.gender==='Masculino'?'üë¶':'üëß'}
                </div>
                <h4 class="text-xl font-black">${p.name}</h4>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">${calculateAge(p.birth)} Meses ‚Ä¢ Faixa ${getRange(calculateAge(p.birth))}</span>
                <div class="mt-6 w-full pt-4 border-t">
                    <button onclick="selectForPresc('${p.id}')" class="w-full py-3 bg-indigo-50 text-indigo-600 rounded-xl font-black text-xs hover:bg-indigo-600 hover:text-white uppercase">Ver Prontu√°rio</button>
                </div>
            </div>
        `).join('');
    }

    // --- EXERC√çCIOS ---
    document.getElementById('exercise-form').onsubmit = (e) => {
        e.preventDefault();
        const ex = {
            id: Date.now().toString(),
            name: document.getElementById('ex-name').value,
            collection: document.getElementById('ex-collection').value,
            age: document.getElementById('ex-age').value,
            img: document.getElementById('ex-img').value,
            time: document.getElementById('ex-time').value,
            reps: document.getElementById('ex-reps').value,
            series: document.getElementById('ex-series').value,
            desc: document.getElementById('ex-desc').value
        };
        exercises.push(ex);
        localStorage.setItem('fk_pro_ex_v9', JSON.stringify(exercises));
        e.target.reset(); toggleForm('exercise-form-container'); renderExercises();
    };

    function renderExercises() {
        const list = document.getElementById('exercises-list');
        const query = document.getElementById('search-ex').value.toLowerCase();
        let pool = exercises;
        
        if(appMode === 'mae' && currentPatId) {
            const p = patients.find(x => x.id === currentPatId);
            const m = calculateAge(p.birth);
            pool = exercises.filter(ex => parseInt(ex.age.split('-')[1]) <= (m + 1));
        }

        const filtered = pool.filter(ex => ex.name.toLowerCase().includes(query) || ex.collection.toLowerCase().includes(query));

        list.innerHTML = filtered.map(ex => `
            <div class="bg-white rounded-[40px] p-6 card-shadow border border-slate-50 flex flex-col h-full">
                <div class="image-container mb-6">
                    <img src="${ex.img || 'https://images.unsplash.com/photo-1516627145497-ae6968895b74?q=80&w=600'}">
                </div>
                <div class="flex justify-between items-center mb-3">
                    <span class="bg-purple-50 text-purple-600 px-4 py-1 rounded-full text-[10px] font-black uppercase">${ex.collection}</span>
                    <span class="text-[10px] font-black text-slate-300 uppercase">${ex.age} m</span>
                </div>
                <h4 class="text-xl font-black text-slate-800 flex-1">${ex.name}</h4>
                ${appMode === 'mae' ? `<button class="mt-4 w-full py-3 bg-green-500 text-white rounded-xl font-black text-xs uppercase">Concluir ‚úÖ</button>` : ''}
            </div>
        `).join('');
    }

    // --- PRESCRI√á√ÉO E MAPA ---
    function initPresc() {
        const container = document.getElementById('presc-patients-list');
        container.innerHTML = patients.map(p => `
            <button onclick="selectForPresc('${p.id}')" class="w-full p-4 text-left rounded-xl font-bold text-sm border-2 ${currentPatId === p.id ? 'border-indigo-600 bg-indigo-50' : 'border-transparent bg-slate-50'}">
                ${p.name} (${calculateAge(p.birth)} meses)
            </button>
        `).join('');
        renderPrescExercises();
    }

    function selectForPresc(id) {
        currentPatId = id;
        switchTab('prescriptions');
        document.getElementById('map-container').classList.remove('hidden');
        renderMap();
        renderPrescExercises();
    }

    function renderMap() {
        const p = patients.find(x => x.id === currentPatId);
        const container = document.getElementById('body-map');
        if(!p) return;
        
        container.innerHTML = axes.map(ax => {
            const status = p.progress[ax] || 'N√£o Iniciado';
            const color = status === 'Consolidado' ? 'bg-green-500' : (status === 'Em Progresso' ? 'bg-yellow-400' : 'bg-slate-200');
            return `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                    <span class="text-[11px] font-black uppercase"><span class="status-dot ${color}"></span>${ax}</span>
                    <select onchange="updateProgress('${ax}', this.value)" class="text-[10px] font-bold bg-white border-none rounded-md" ${appMode==='mae'?'disabled':''}>
                        <option ${status==='N√£o Iniciado'?'selected':''}>N√£o Iniciado</option>
                        <option ${status==='Em Progresso'?'selected':''}>Em Progresso</option>
                        <option ${status==='Consolidado'?'selected':''}>Consolidado</option>
                    </select>
                </div>
            `;
        }).join('');
    }

    function updateProgress(ax, val) {
        const p = patients.find(x => x.id === currentPatId);
        p.progress[ax] = val;
        localStorage.setItem('fk_pro_pat_v9', JSON.stringify(patients));
        renderMap();
    }

    function renderPrescExercises() {
        const grid = document.getElementById('presc-exercises-grid');
        if(!currentPatId) {
            grid.innerHTML = "<p class='text-center text-slate-400 font-bold py-10'>Selecione um paciente para ver exerc√≠cios sugeridos.</p>";
            return;
        }
        
        const p = patients.find(x => x.id === currentPatId);
        const m = calculateAge(p.birth);
        const pool = exercises.filter(ex => ex.age === getRange(m));

        grid.innerHTML = pool.map(ex => `
            <div onclick="togglePrescEx('${ex.id}')" class="p-4 rounded-3xl border-2 cursor-pointer flex items-center gap-4 ${selectedExIds.has(ex.id) ? 'border-indigo-50 bg-indigo-50' : 'border-slate-50 bg-white'}">
                <div class="w-12 h-12 rounded-xl bg-slate-200 bg-cover bg-center" style="background-image: url('${ex.img}')"></div>
                <div class="flex-1">
                    <h6 class="font-bold text-sm">${ex.name}</h6>
                    <p class="text-[9px] text-slate-400 font-black uppercase">${ex.collection}</p>
                </div>
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center text-xs ${selectedExIds.has(ex.id) ? 'bg-indigo-600 text-white border-indigo-600' : 'border-slate-200 text-transparent'}">‚úì</div>
            </div>
        `).join('');
        document.getElementById('presc-count').innerText = `${selectedExIds.size} SELECIONADOS`;
    }

    function togglePrescEx(id) {
        if(selectedExIds.has(id)) selectedExIds.delete(id); else selectedExIds.add(id);
        renderPrescExercises();
    }

    // --- PDF ENGINE ---
    async function getBase64(url) {
        if(!url) return null;
        return new Promise((resolve) => {
            const img = new Image();
            img.setAttribute("crossOrigin", "anonymous");
            img.onload = () => {
                const canvas = document.createElement("canvas");
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL("image/jpeg", 0.7));
            };
            img.onerror = () => resolve(null);
            img.src = url;
        });
    }

    async function generateSuperPDF() {
        if(!currentPatId || selectedExIds.size === 0) return alert('Selecione um paciente e os exerc√≠cios do plano!');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const p = patients.find(x => x.id === currentPatId);
        const selectedList = exercises.filter(ex => selectedExIds.has(ex.id));

        // Capa
        doc.setFillColor(99, 102, 241); doc.rect(0, 0, 210, 297, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(30); doc.text("GUIA DE ESTIMULA√á√ÉO", 105, 100, {align:'center'});
        doc.setFontSize(22); doc.text(p.name.toUpperCase(), 105, 120, {align:'center'});
        doc.setFontSize(10); doc.text("Dra. Eul√°lia Angelim - Fisioterapia Neurofuncional Pedi√°trica", 105, 280, {align:'center'});

        for(let ex of selectedList) {
            doc.addPage();
            doc.setTextColor(99, 102, 241); doc.setFontSize(20); doc.text(ex.name, 15, 25);
            doc.setFontSize(10); doc.setTextColor(150); doc.text(`Eixo: ${ex.collection} | Faixa: ${ex.age} meses`, 15, 32);
            
            let y = 40;
            const b64 = await getBase64(ex.img);
            if(b64) { 
                doc.addImage(b64, 'JPEG', 15, y, 180, 100); 
                y += 110; 
            }

            doc.setFillColor(168, 85, 247); doc.roundedRect(15, y, 180, 10, 2, 2, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(9);
            doc.text(`Objetivo: ${ex.time||'-'} min | Reps: ${ex.reps||'-'} | S√©ries: ${ex.series||'-'}`, 20, y + 7);
            
            y += 20;
            doc.setTextColor(50); doc.setFontSize(12); doc.text("Como Realizar:", 15, y);
            doc.setFontSize(10);
            const lines = doc.splitTextToSize(ex.desc, 180);
            doc.text(lines, 15, y + 8);
        }

        doc.save(`FisioKids_Guia_${p.name}.pdf`);
    }

    renderPatients();
    renderExercises();
</script>

</body>
</html>